name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.7.2
          args: --timeout=5m

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Run gosec
        run: gosec -quiet ./...

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${COVERAGE}%"
          # Phase 0 threshold: 40% (will increase as we add more logic)
          if (( $(echo "$COVERAGE < 40" | bc -l) )); then
            echo "Coverage ${COVERAGE}% is below threshold 40%"
            exit 1
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, security, test]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Build
        run: go build -v ./cmd/devsec

  verify-safepath:
    name: Verify SafePath Usage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for prohibited os file I/O
        run: |
          if grep -rn "os\.Open\|os\.Create\|os\.ReadFile\|os\.WriteFile\|os\.Remove\|os\.Mkdir\|ioutil\." --include="*.go" . | grep -v "_test.go" | grep -v "vendor/"; then
            echo "ERROR: Direct os file I/O detected. Use github.com/victoralfred/gowritter instead."
            exit 1
          fi
          echo "No prohibited file I/O found."

  notify:
    name: Slack Notification
    runs-on: ubuntu-latest
    needs: [lint, security, test, build, verify-safepath]
    if: always()
    environment: production
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ "${{ needs.lint.result }}" == "success" ] && \
             [ "${{ needs.security.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.build.result }}" == "success" ] && \
             [ "${{ needs.verify-safepath.result }}" == "success" ]; then
            STATUS="success"
            COLOR="good"
            TEXT="All CI checks passed for devsec"
          else
            STATUS="failure"
            COLOR="danger"
            TEXT="CI checks failed for devsec"
          fi

          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "Warning: SLACK_WEBHOOK_URL not configured, skipping notification"
            exit 0
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"CI Pipeline $STATUS\",
                \"text\": \"$TEXT\",
                \"fields\": [
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                  {\"title\": \"Commit\", \"value\": \"${{ github.sha }}\", \"short\": true},
                  {\"title\": \"Actor\", \"value\": \"${{ github.actor }}\", \"short\": true}
                ],
                \"footer\": \"GitHub Actions\",
                \"ts\": $(date +%s)
              }]
            }" \
            "$SLACK_WEBHOOK_URL"