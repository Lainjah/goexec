name: Release

on:
  push:
    tags: ['v*']

jobs:
  pre-release-checks:
    name: Pre-Release Checks
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-1.22-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-1.22-

    - name: Install tools
      run: make tools

    - name: Run pre-release checks
      run: make pre-release

    - name: Upload test coverage
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: |
          coverage.out
          coverage.integration.out
        retention-days: 90

  release:
    name: Create Release
    needs: [pre-release-checks]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version from tag
      id: version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Extract release notes from CHANGELOG
      id: changelog
      run: |
        VERSION="${GITHUB_REF#refs/tags/v}"
        echo "Extracting notes for version $VERSION"

        # Extract section for this version from CHANGELOG.md
        if [ -f CHANGELOG.md ]; then
          # Extract content between this version header and the next version header
          awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md > release-notes.txt

          if [ ! -s release-notes.txt ]; then
            echo "No specific notes found, using default"
            echo "Release $VERSION" > release-notes.txt
          fi
        else
          echo "CHANGELOG.md not found, generating from commits"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD > release-notes.txt
          else
            git log --pretty=format:"- %s (%h)" > release-notes.txt
          fi
        fi

        cat release-notes.txt

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: GoExec ${{ steps.version.outputs.version }}
        body_path: release-notes.txt
        draft: false
        prerelease: ${{ contains(steps.version.outputs.version, '-') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-release:
    name: Notify Release
    needs: [pre-release-checks, release]
    runs-on: ubuntu-latest
    if: always()
    environment: production

    steps:
    - name: Determine status
      id: status
      run: |
        if [ "${{ needs.pre-release-checks.result }}" == "success" ] && \
           [ "${{ needs.release.result }}" == "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "emoji=ðŸš€" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "emoji=âŒ" >> $GITHUB_OUTPUT
        fi

    - name: Send Slack notification
      if: ${{ env.SLACK_WEBHOOK_URL != '' }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      uses: slackapi/slack-github-action@v1
      with:
        webhook-url: ${{ env.SLACK_WEBHOOK_URL }}
        payload: |
          {
            "text": "${{ steps.status.outputs.emoji }} GoExec Release ${{ github.ref_name }} ${{ steps.status.outputs.status == 'success' && 'Published' || 'Failed' }}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${{ steps.status.outputs.emoji }} GoExec Release ${{ steps.status.outputs.status == 'success' && 'Published' || 'Failed' }}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {"type": "mrkdwn", "text": "*Version:*\n${{ github.ref_name }}"},
                  {"type": "mrkdwn", "text": "*Author:*\n${{ github.actor }}"}
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Results:*\nâ€¢ Pre-Release Checks: ${{ needs.pre-release-checks.result }}\nâ€¢ Release: ${{ needs.release.result }}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {"type": "plain_text", "text": "View Release"},
                    "url": "https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
                  }
                ]
              }
            ]
          }
